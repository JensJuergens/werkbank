---
title: "Fits, misfits and cannibals - challenges in renewables power production"
date: 2019-03-29
tags: [production, simulation, R, portfolio optimisation, volatility]
excerpt: "Setup and Testing"
mathjax: true
header:
  overlay_image: /images/windDenmark.jpg

---
More than 35% of Germany's [power production](https://w3.windmesse.de/windenergie/news/31115-rekord-monat-erneuerbare-energie-strommix-deutschland-anteil-windenergie) was produced by renewable energy last March, where a major stake was created by wind. But have you ever wondered, if this figure will be stable or even constantly rise through the coming months?

This question can neither be easily answered, nor do I promise a crystal ball. But we can try to sketch future production with statistical means in order to get a sensible feeling for the uncertainty in renewables production profiles. To start things, my first post is about the setup of a nice, small model, which is capable of forecasting daily production volume of renewable power plants while being analytically tractable. We will enhance and modify the model in the upcoming posts, jumping between fits and misfits of model and its data. All calculations are done with R and are implementations of methods carried out in the cited academic papers. We start by investigating daily historical production data.
## Data Description
What we see in the plot below are the daily production profiles of a German wind farm (turquoise) and a Romanian solar park (golden).
<figure class="one">
    <a href="{{ site.url }}{{ site.baseurl }}/images/production_profile.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/production_profile.jpeg"></a>
    <figcaption> Production profile of wind and solar, source: Transparency Reports Statistics </figcaption>
</figure>
After having a first look at the chart, we observe a clear yearly, seasonal pattern which results from the availability of the natural resources wind and sun. In other words, there is a lot more wind in the winter season as in summertime. Consequently, the wind production volume rises with the beginning of the winter season. Hence only relying on wind in your renewables portfolio is evidently not really a good idea, as one will suffer from lower production cycles in summer. How can this be compensated?

Looking at the given solar production profile, we observe quite the opposite behaviour to wind, as sun intensity is more prominent in summertime. Of course, this results in rising solar production in respective season. This pattern can further be drilled down to monthly as well as weekly seasonality forces the observed production profiles to behave as curvy as they do.

What both charts have in common is a production behaviour, which quickly returns to its seasonal mean after rapidly surging with a spike. Evidently these spikes appear far more often and are thus more prevalent in wind production than in regards to a solar power plant. This is also due to the fact, that we generally experience wind more unstable than cozy sun intensity. Consequently, the renewable asset class wind should be far more volatile than the Romanian photovoltaic power plant. In a qualitative way consequently balancing out wind farms with PV should give us quite stable production cycles through the year, which is already a hint at our initial question.

But as this blog is of quantitative nature, let us see, what the numbers say in the end.
## The model
In terms of model formulation we stick to the model of [Lucia&Schwartz](https://link.springer.com/article/10.1023/A:1013846631785) or [Kluge](https://www.researchgate.net/publication/266336023_Pricing_Swing_Options_and_Other_Electricity_Derivatives) and adapt it to the power production case. We are going to evaluate the forecasting performance of this model at the end of this post. These kind of models are attractive, because they are tractable and parameters are relatively easy to calculate. Besides, using this formulation for production simulation purposes is not as unusual as it might seem at first sight (cf. [Benth](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2979341)).

$$
\begin{align*}
S(t) &=  exp(f(t)+X(t)) \\
dX(t) &= (\mu-\alpha)X(t)dt+\sigma dW(t) \\
f(t)  &=  a_0+\sum_{i=1}^6[a_i cos(2\pi\gamma_it)+b_i sin(2\pi\gamma_i t)] \\
\end{align*}
$$

The truncated fourier series $f(t)$ is used to describe seasonality seen in the data above. A lot of different ways to capture seasonality have been tried out and we will stick to the following seasonality approach as it captures yearly, monthly as well as weekly seasonality. We set the parameters $$ \gamma_1 = 1, \gamma_2 = 2 ,\gamma_3 = 4, \gamma_4 = \frac{365}{7}, \gamma_5 = 2*\frac{365}{7}, \gamma_6 = 4*\frac{365}{7} $$, which corresponds to annually, semi-annually, quarterly, weekly, semi-weekly and quarter-weekly seasonality factors.

We use a logarithmic model, where the dynamic is driven by a mean-reverting Ornstein-Uhlenbeck process. Parameter $\alpha$ describes the mean reversion speed or in other words how fast the production returns to its seasonal mean after experiencing a spike. As usual $\sigma$ represents the volatility of the underlying. Honestly speaking I am always unsure about the parameter $\mu$. I know models where this parameter is left out, because calibration often sets $\mu$ to zero, but for our exercise we will drag him along.
## Calibration
As pointed out above, seasonality seems to play a major role in our time series. Hence we will firstly estimate the seasonality with a simple linear regression of trigonometric basis functions against the logarithm of observed daily production volumes. To uncover yearly seasonality we will use three years of historical daily production volumes. Results of the linear model are as follows:
<figure class="half">
    <a href="{{ site.url }}{{ site.baseurl }}/images/wind_german_season.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/wind_german_season.jpeg"></a>
    <a href="{{ site.url }}{{ site.baseurl }}/images/solar_romania_season.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/solar_romania_season.jpeg"></a>
    <figcaption> Seasonality per asset estimated by truncated fourier series </figcaption>
</figure>
To carry out a sensible calibration of the model parameters \alpha$ and $\sigma$, we have to remove disturbing patterns in the time series in order to arrive at the pure stochastic part. After determining the seasonality, we deseasonalize our log-Spot data by subtracting the seasonality function from the data.
<figure class="one">
    <a href="{{ site.url }}{{ site.baseurl }}/images/production_profile_deseasonalised.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/production_profile_deseasonalised.jpeg"></a>
    <figcaption> Deseasonalised observed production volume </figcaption>
</figure>
Now we are half-way done in extracting the pure stochastic part in our data. Given a wind farm there are a lot of artifacts, which result e.g. from O&M measure at the park. We will winsorize them out,so that these artifacts will not disturb our parameter estimation of $$ {\alpha, \sigma}  $$. After doing so, we arrive at the following stage:
<figure class="half">
    <a href="{{ site.url }}{{ site.baseurl }}/images/wind_german_deseason_winsor.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/wind_german_deseason_winsor.jpeg"></a>
    <a href="{{ site.url }}{{ site.baseurl }}/images/solar_romania_deseason_winsor.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/solar_romania_deseason_winsor.jpeg"></a>
    <figcaption> Deseasonalised and winsoried observed production volumes  </figcaption>
</figure>
It is very interesting fact, that deseasonalisation as well as winsorisation clearly made different regimes of volatility visible in our data. Especially if we have a look at our solar plant, we see a lot more volatility in winter than in summer, which is quite understandable when we remember ourselves being exposed to the weather of these seasons. Having our model in mind, the hypothesis of constant volatility seems to be fair enough for the moment, but a bit simplified for the future.

Returning to our technical analysis, further calibration will be carried out by the means of a maximum likelihood estimation. We use the fact that transitional densities for an Ornstein-Uhlenbeck process are given, which helps us to boil the calibration down to numerical estimate $$ \alpha $$. The maximum likelihood method is carried out with a Brent Solver, all other parameters are then explicitly calculated through the estimated $$ \alpha $$.
## Testing of calibration results
 Disjunct quarterly, semi-annual as well as annual estimation horizons were tested and I recommend to use at least semi-annual daily observations in order to arrive at sensible estimation results. For the sake of fun I tried quarterly observation horizons out, but it seemed more than roulette to arrive at a density plot which has something to with actual power production profile. To use quarterly observation horizon, one must include hourly production to guarantee enough data points. I have compared the density of historical log returns against an artificial normal distribution, which is built with calibrated parameters.
 <figure class="third">
  <a href="{{ site.url }}{{ site.baseurl }}/images/Wind Production Germanydensity_plot_2016-01-01_sim_yearly.png"><img src="{{ site.url }}{{ site.baseurl }}/images/Wind Production Germanydensity_plot_2016-01-01_sim_yearly.png"></a>
  <a href="{{ site.url }}{{ site.baseurl }}/images/Wind Production Germanydensity_plot_2016-12-31_sim_yearly.png"><img src="{{ site.url }}{{ site.baseurl }}/images/Wind Production Germanydensity_plot_2016-12-31_sim_yearly.png"></a>
  <a href="{{ site.url }}{{ site.baseurl }}/images/Wind Production Germanydensity_plot_2017-12-31_sim_yearly.png"><img src="{{ site.url }}{{ site.baseurl }}/images/Wind Production Germanydensity_plot_2017-12-31_sim_yearly.png"></a>
	<figcaption>Calibration results with annual time windows for German wind park</figcaption>
</figure>
Let us have a look at the Romanian solar park:
<figure class="third">
 <a href="{{ site.url }}{{ site.baseurl }}/images/Solar Production Romaniadensity_plot_2016-03-24_sim_yearly.png"><img src="{{ site.url }}{{ site.baseurl }}/images/Solar Production Romaniadensity_plot_2016-03-24_sim_yearly.png"></a>
 <a href="{{ site.url }}{{ site.baseurl }}/images/Solar Production Romaniadensity_plot_2016-12-29_sim_yearly.png"><img src="{{ site.url }}{{ site.baseurl }}/images/Solar Production Romaniadensity_plot_2016-12-29_sim_yearly.png"></a>
 <a href="{{ site.url }}{{ site.baseurl }}/images/Solar Production Romaniadensity_plot_2017-12-30_sim_yearly.png"><img src="{{ site.url }}{{ site.baseurl }}/images/Solar Production Romaniadensity_plot_2017-12-30_sim_yearly.png"></a>
 <figcaption>Calibration results with annual time windows for Romania solar park</figcaption>
</figure>
Quite visually we see a reasonable fit between the real data and the artificial density function with our estimated parameters. Nevertheless the normal distribution is not capable of capturing the tails in the empirical distribution, precisely when we have a look at the wind production. This arises not only because of the limitations of the normal distribution, but also because of the already mentioned non-constant volatility in the data. But before diving into the depths about the distribution hypothesis, let us draw a few samples with a Monte-Carlo simulation of the SDE above. We will calibrate seasonality and SDE parameters to the data of 2016-2017 and plot simulated sample paths against 2018 data. Honestly it would not be necessary to install Monte-Carlo machinery, as it would be sufficient to compare the seasonality function with the real data. But we will need the Monte-Carlo machine in the end, so let us deploy it now. In order to simulate the above SDEs, we will use a standard Euler scheme and arrive - thanks to the fantastic grammar of graphics - at the following plot:
<figure class="one">
    <a href="{{ site.url }}{{ site.baseurl }}/images/romanian_fancy_simulation.jpeg"><img src="{{ site.url }}{{ site.baseurl }}/images/romanian_fancy_simulation.jpeg"></a>
    <figcaption> Daily simulation of Romanian solar plant with calibration to 2016-2017 and drawing 2018. </figcaption>
</figure>
I think some explanations about the coloring are necessary. The black trembling line is our already known real historical data for 2018. The fancy noise in the background show 100 different Monte-Carlo example paths, which were generated with paramters calibrated to 2016/2017 and past future paths generated by our simulated equation. Red lines represent standard errors, where I tried to give us a more general impression about the error with the grey smoothing graph. This on was generated by a spline interpolation of the absolute difference between real data and the mean of our Monte-Carlo simulation. As you see the error is reasonable low. Of course the simulation did not reproduce the exact same line as the real production, but I would say the model has definitely a good fit to the data. Wind production shows exactly the same result, so we skip it out here.

Let us summarise what we have achieved so far. We now have model, which shows a reasonable fit to real data, but of course has some limitations when it comes to volatility. Simulating an equation with this model shows again paths, which are similiar to actual production volumes. Now let us try to achieve something economical useful with the model.

Getting back at our introductory question, we would like to have most stable production throughout the year, whicht is at least at now time below a certain downside limit.
<figure class="one">
    <a href="{{ site.url }}{{ site.baseurl }}/images/mixture_density.png"><img src="{{ site.url }}{{ site.baseurl }}/images/mixture_density.png"></a>
    <figcaption> Iteratively changing weights in mixture density distribution for our portfolio of a wind and solar farm  </figcaption>
</figure>
This can be achieved by constantly shifting up and down the production of a solar and a wind power plant, which is represented by adjusting the weights in our mixture distribution. We will do it daily in a way that returns are never below the downside limit represented by the red line in the chart. That is the idea and now as we have all our ingredients together, let us put it into a bowl and create a nice algorithm that constantly rebalances our portfolio consisting of the German wind farm and the Romanian PV park.

## Key Takeaways and further steps

In case you feel like Jordan Belfort going to you boss saying " I've got the recipe for eliminating uncertainty in our production", I must heavily disappoint you.
What should we do now? For example we could start with normal mixture models and try to fit the tails of the observed distributions. Honestly I am not the biggest fan of normal mixture distribution as they are quite cumbersome in fitting. So I propose a family of distributions and we will use the Akaike Information Criterion to show the goodness of fit tests.
* Oh my god we have a well balanced portfolio, that is so awesome. The truth is, that we left out the price, which makes things more and more complicated. Consider this: You have carried out a perfect simulation and have weather information, which tells you to shift up production of Norther Germany wind parks. Unfortunately everyone else in the renewables business should know that, too, and hence will also put...

#![Alt Text](https://media.giphy.com/media/vFKqnCdLPNOKc/giphy.gif)
